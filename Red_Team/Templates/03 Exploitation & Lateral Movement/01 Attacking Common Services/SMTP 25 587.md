## Service SMTP 25 587

### Enumeration
- Enumeration methods vary between services. 
- Cloud providers often use unique mail server implementations and modern authentication, creating service-specific attack vectors.
- Company-configured services may reveal misconfigurations and bad practices, making them vulnerable to common mail server protocol attacks.

### Misconfigurations

#### Authentication

Automate the process with [smtp-user-enum](https://github.com/pentestmonkey/smtp-user-enum).
```shell
 smtp-user-enum -M RCPT -U userlist.txt -D <% tp.frontmatter["VHOST"] %> -t <% tp.frontmatter["RHOSTS"] %>
```

```shell
smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7

Starting smtp-user-enum v1.2 ( http://pentestmonkey.net/tools/smtp-user-enum )

 ----------------------------------------------------------
|                   Scan Information                       |
 ----------------------------------------------------------

Mode ..................... RCPT
Worker Processes ......... 5
Usernames file ........... userlist.txt
Target count ............. 1
Username count ........... 78
Target TCP port .......... 25
Query timeout ............ 5 secs
Target domain ............ inlanefreight.htb

######## Scan started at Thu Apr 21 06:53:07 2022 #########
10.129.203.7: jose@inlanefreight.htb exists
10.129.203.7: pedro@inlanefreight.htb exists
10.129.203.7: kate@inlanefreight.htb exists
######## Scan completed at Thu Apr 21 06:53:18 2022 #########
3 results.

78 queries in 11 seconds (7.1 queries / sec)
```


### Password Attacks

#### Hydra

```shell-session
hydra -L <user-list> -p <password> -f <% tp.frontmatter["RHOSTS"] %> smtp
```

```shell
hydra -L users.txt -p 'Company01!' -f 10.10.110.20 smtp
```


### Protocol Specifics Attacks
#### Open Relay
```shell
nmap -p25 -Pn --script smtp-open-relay <% tp.frontmatter["RHOSTS"] %>
```

```shell
swaks --from <email> --to <email> --header 'Subject: <subject>' --body '<body>' --server <% tp.frontmatter["RHOSTS"] %>
```

**Example**
```shell
swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213
```


### Interact with Services

#### Telnet 
```bash
telnet <% tp.frontmatter["RHOSTS"] %> 25

```
##### HELO/EHLO
**Example**
```bash
telnet 10.129.14.128 25

Trying 10.129.14.128...
Connected to 10.129.14.128.
Escape character is '^]'.
220 ESMTP Server 


HELO mail1.inlanefreight.htb

250 mail1.inlanefreight.htb


EHLO mail1

250-mail1.inlanefreight.htb
250-PIPELINING
250-SIZE 10240000
250-ETRN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-DSN
250-SMTPUTF8
250 CHUNKING
```

##### VRFY
**Example**
```bash
telnet 10.129.14.128 25

Trying 10.129.14.128...
Connected to 10.129.14.128.
Escape character is '^]'.
220 ESMTP Server 

VRFY root

252 2.0.0 root


VRFY cry0l1t3

252 2.0.0 cry0l1t3


VRFY testuser

252 2.0.0 testuser


VRFY aaaaaaaaaaaaaaaaaaaaaaaaaaaa

252 2.0.0 aaaaaaaaaaaaaaaaaaaaaaaaaaaa
```

##### Send an Email
**Example**
```bash
telnet 10.129.14.128 25

Trying 10.129.14.128...
Connected to 10.129.14.128.
Escape character is '^]'.
220 ESMTP Server


EHLO inlanefreight.htb

250-mail1.inlanefreight.htb
250-PIPELINING
250-SIZE 10240000
250-ETRN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-DSN
250-SMTPUTF8
250 CHUNKING


MAIL FROM: <cry0l1t3@inlanefreight.htb>

250 2.1.0 Ok


RCPT TO: <mrb3n@inlanefreight.htb> NOTIFY=success,failure

250 2.1.5 Ok


DATA

354 End data with <CR><LF>.<CR><LF>

From: <cry0l1t3@inlanefreight.htb>
To: <mrb3n@inlanefreight.htb>
Subject: DB
Date: Tue, 28 Sept 2021 16:32:51 +0200
Hey man, I am trying to access our XY-DB but the creds don't work. 
Did you make any changes there?
.

250 2.0.0 Ok: queued as 6E1CF1681AB


QUIT

221 2.0.0 Bye
Connection closed by foreign host.
```


### [OpenSMTPD](https://www.opensmtpd.org/) up to version 6.6.2
#### Initiation of the Attack

|**Step**|**Remote Code Execution**|**Concept of Attacks - Category**|
|---|---|---|
|`1.`|The source is the user input that can be entered manually or automated during direct interaction with the service.|`Source`|
|`2.`|The service will take the email with the required information.|`Process`|
|`3.`|Listening to the standardized ports of a system requires `root` privileges on the system, and if these ports are used, the service runs accordingly with elevated privileges.|`Privileges`|
|`4.`|As the destination, the entered information is forwarded to another local process.|`Destination`|

This is when the cycle starts all over again, but this time to gain remote access to the target system.

#### Trigger Remote Code Execution

|**Step**|**Remote Code Execution**|**Concept of Attacks - Category**|
|---|---|---|
|`5.`|This time, the source is the entire input, especially from the sender area, which contains our system command.|`Source`|
|`6.`|The process reads all the information, and the semicolon (`;`) interrupts the reading due to special rules in the source code that leads to the execution of the entered system command.|`Process`|
|`7.`|Since the service is already running with elevated privileges, other processes of OpenSMTPD will be executed with the same privileges. With these, the system command we entered will also be executed.|`Privileges`|
|`8.`|The destination for the system command can be, for example, the network back to our host through which we get access to the system.|`Destination`|

An [exploit](https://www.exploit-db.com/exploits/47984) has been published on the [Exploit-DB](https://www.exploit-db.com/) platform for this vulnerability which can be used for more detailed analysis and the functionality of the trigger for the execution of system commands.